<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç•¶æ²–åˆ¸å·®å€Ÿåˆ¸è²»ç‡ Top 10</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
           background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height: 100vh; color: #333; }
    .container { max-width: 800px; margin: 0 auto; padding: 20px; }
    .header { text-align: center; color: #fff; margin-bottom: 20px; }
    .header h1 { font-size: 1.8rem; text-shadow: 2px 2px 4px rgba(0,0,0,.3); margin-bottom: 8px; }
    .header p { opacity: .9; font-size: 14px; }
    .update-time { display: inline-block; margin-top: 10px; padding: 6px 14px; border-radius: 20px;
                   background: rgba(255,255,255,.2); backdrop-filter: blur(10px); font-size: 13px; }
    .controls { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; 
                box-shadow: 0 8px 24px rgba(0,0,0,.08); }
    .date-selector { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;}
    .date-selector label { font-weight: 600; color: #333; }
    .date-selector select { padding: 8px 12px; border: 2px solid #dee2e6; border-radius: 8px; 
                           font-size: 14px; background: #fff; min-width: 160px; }
    .button-group { text-align: center; }
    button { padding: 12px 20px; font-size: 14px; border-radius: 8px; cursor: pointer; 
             border: none; background: #667eea; color: #fff; font-weight: 600; 
             transition: all 0.2s; margin: 0 5px; }
    button:hover { background: #5a6fd8; transform: translateY(-1px); }
    .loading { color: #666; text-align: center; padding: 20px; background: #fff; border-radius: 12px; }
    .table-section { background: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.08); overflow: hidden; }
    .section-header { background: linear-gradient(135deg,#667eea,#764ba2); color: #fff; 
                     padding: 15px 20px; font-weight: 600; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8f9fa; color: #666; font-size: 13px; font-weight: 600; 
         text-align: left; padding: 12px 15px; border-bottom: 2px solid #dee2e6; }
    td { padding: 12px 15px; border-bottom: 1px solid #eee; }
    tr:hover { background: #f8f9ff; }
    .rank { background: linear-gradient(135deg, #ffd700, #ffed4e); color: #333; 
            font-weight: bold; text-align: center; border-radius: 50%; 
            width: 25px; height: 25px; line-height: 25px; font-size: 12px; margin: 0 auto; }
    .rank.top3 { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: #fff; }
    .qty { font-weight: 600; color: #2d3436; }
    .fee { color: #e17055; font-weight: 500; }
    .date-info { text-align: center; background: #e8f4f8; padding: 10px; 
                 color: #2d3436; font-size: 14px; font-weight: 500; }
    .alert { margin: 15px 0; padding: 12px 16px; border-radius: 8px; 
             background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; 
             text-align: center; display: none; }
    .alert.success { background: #e8f5e9; border-color: #a5d6a7; color: #2e7d32; }
    .alert.error { background: #ffebee; border-color: #ffcdd2; color: #c62828; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ† ç•¶æ²–åˆ¸å·®å€Ÿåˆ¸è‚¡æ•¸ Top 10</h1>
      <p>ä¾ã€Œåˆ¸å·®æ—¥æœŸã€é¸æ“‡ä¸¦é¡¯ç¤ºç•¶æ—¥åŠ ç¸½æœ€å¤šçš„å‰10å</p>
      <div class="update-time" id="lastUpdate">æº–å‚™è¼‰å…¥è³‡æ–™...</div>
    </div>

    <div class="controls">
      <div class="date-selector">
        <label for="dateSelect">ğŸ“… åˆ¸å·®æ—¥æœŸï¼š</label>
        <select id="dateSelect">
          <option value="">è«‹å…ˆè¼‰å…¥è³‡æ–™</option>
        </select>
      </div>
      <div class="button-group">
        <button id="btnRefresh">ğŸ”„ é‡æ–°æŠ“å–</button>
        <button id="btnExport">ğŸ“¥ åŒ¯å‡º CSV</button>
      </div>
    </div>

    <div id="alertMsg" class="alert"></div>
    <div id="loadingMsg" class="loading">è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™...</div>

    <div class="table-section" id="tableSection" style="display: none;">
      <div class="section-header">
        <span>ğŸ“Š å€Ÿåˆ¸è‚¡æ•¸æ’è¡Œæ¦œ</span>
      </div>
      <div class="date-info" id="dateInfo"></div>
      <table>
        <thead>
          <tr>
            <th style="width: 60px; text-align: center;">æ’å</th>
            <th>è­‰åˆ¸ä»£è™Ÿ</th>
            <th>è­‰åˆ¸åç¨±</th>
            <th style="text-align: right;">å€Ÿåˆ¸è‚¡æ•¸</th>
            <th style="text-align: right;">å¹³å‡è²»ç‡</th>
            <th style="text-align: center;">ä¾†æº</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ====== å·¥å…· ======
    const nf = new Intl.NumberFormat('zh-TW');
    const showAlert = (msg, type='info') => {
      const el = document.getElementById('alertMsg');
      el.textContent = msg;
      el.className = `alert ${type}`;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    };
    const updateClock = () => {
      document.getElementById('lastUpdate').textContent =
        'æœ€å¾Œæ›´æ–°ï¼š' + new Date().toLocaleString('zh-TW', {
          year: 'numeric', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    };
    const toNum = v => Number(String(v ?? '').replace(/[,\s%]/g,'')) || 0;

    // ROC(æ°‘åœ‹)è½‰ISOæ—¥æœŸ
    const rocToISO = (s) => {
      const m = String(s).match(/(\d{2,3})[\/å¹´.-](\d{1,2})[\/æœˆ.-](\d{1,2})/);
      if(!m) return '';
      const y = (+m[1] + 1911).toString().padStart(4,'0');
      const mm = m[2].padStart(2,'0');
      const dd = m[3].padStart(2,'0');
      return `${y}-${mm}-${dd}`;
    };

    // ====== è³‡æ–™ä¾†æº ======
    const URL_TPEX = 'https://www.tpex.org.tw/www/zh-tw/intraday/fee?id=&response=html';
    const URL_TWSE = 'https://www.twse.com.tw/rwd/zh/dayTrading/BFIF8U?response=html';

    async function fetchHTML(url) {
      try {
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.text();
      } catch (e) {
        const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
        const r2 = await fetch(proxy, { cache: 'no-store' });
        if (!r2.ok) throw new Error(`Proxy HTTP ${r2.status}`);
        return await r2.text();
      }
    }

    function parseFeeTable(htmlText, source) {
      const doc = new DOMParser().parseFromString(htmlText, 'text/html');
      const tables = Array.from(doc.querySelectorAll('table'));
      let table = tables.find(t =>
        /åˆ¸å·®æ—¥æœŸ/.test(t.textContent) && /è­‰åˆ¸ä»£è™Ÿ/.test(t.textContent)
      );
      if (!table) return [];

      // æ‰¾åˆ°åŒ…å«æ¨™é¡Œåˆ—ï¼ˆä¸èƒ½æœ‰ colspanï¼‰
      const headerTr = Array.from(table.querySelectorAll('thead tr, tr')).find(tr => {
        const ths = Array.from(tr.querySelectorAll('th'));
        if (ths.length < 4) return false;
        if (ths.some(th => th.hasAttribute('colspan'))) return false;
        const text = ths.map(th => th.textContent.trim()).join(',');
        return /åˆ¸å·®æ—¥æœŸ/.test(text) && /è­‰åˆ¸ä»£è™Ÿ/.test(text);
      });
      if (!headerTr) return [];

      const headers = Array.from(headerTr.querySelectorAll('th')).map(th => th.textContent.trim());
      const idx = (re) => headers.findIndex(h => re.test(h));
      const iDate = idx(/åˆ¸å·®æ—¥æœŸ/);
      const iCode = idx(/è­‰åˆ¸ä»£è™Ÿ/);
      const iName = idx(/è­‰åˆ¸åç¨±/);
      const iQty  = idx(/(æŠ•è³‡äºº)?å€Ÿåˆ¸è‚¡æ•¸/);
      const iFee  = idx(/(æŠ•è³‡äºº)?å€Ÿåˆ¸è²»ç‡/);

      const bodyTrs =
        Array.from(table.querySelectorAll('tbody tr')).length
          ? Array.from(table.querySelectorAll('tbody tr'))
          : Array.from(table.querySelectorAll('tr')).filter(tr => tr.querySelectorAll('td').length);

      const rows = [];
      for (const tr of bodyTrs) {
        const tds = Array.from(tr.querySelectorAll('td,th')).map(td => td.textContent.trim());
        if (!tds.length) continue;

        const dateStr = tds[iDate] || '';
        const code = tds[iCode] || '';
        const name = tds[iName] || '';
        const qty  = toNum(tds[iQty]);

        let feeRaw = (tds[iFee] ?? '').replace('%','').trim();
        const fee = feeRaw === '' ? null : Number(feeRaw);

        if (!dateStr || !code) continue;

        const iso = rocToISO(dateStr);
        rows.push({
          date: dateStr,       // åŸå§‹ï¼ˆæ°‘åœ‹ï¼‰å­—ä¸²
          dateISO: iso,        // ISO yyyy-mm-dd
          source, code, name, qty, fee
        });
      }
      return rows;
    }

    // ====== ç‹€æ…‹ ======
    let ALL_ROWS = [];          // å…¨ä¾†æºã€å…¨æ—¥æœŸåŸå§‹åˆ—
    let AVAILABLE_DATES = [];   // å¯é¸æ—¥æœŸ [{iso, display}]
    let TOP10_DATA = [];        // ç›®å‰é¸å®šæ—¥æœŸçš„å½™æ•´çµæœ
    let CURRENT_DATE_ISO = '';  // ç›®å‰é¸å®šæ—¥æœŸï¼ˆISOï¼‰

    // ä¾æŒ‡å®šæ—¥æœŸé‡ç®— Top10
    function computeTop10ByDate(dateISO) {
      const rows = ALL_ROWS.filter(r => r.dateISO === dateISO);
      const codeMap = new Map();
      for (const row of rows) {
        if (!codeMap.has(row.code)) {
          codeMap.set(row.code, {
            code: row.code,
            name: row.name,
            totalQty: 0,
            fees: [],
            sources: new Set()
          });
        }
        const item = codeMap.get(row.code);
        item.totalQty += row.qty;
        if (row.fee !== null) item.fees.push(row.fee);
        item.sources.add(row.source);
      }

      TOP10_DATA = Array.from(codeMap.values())
        .map(item => ({
          ...item,
          avgFee: item.fees.length ? item.fees.reduce((a,b) => a+b, 0) / item.fees.length : null,
          sourcesText: Array.from(item.sources).join(', ')
        }))
        .sort((a,b) => b.totalQty - a.totalQty)
        .slice(0, 10);
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
      const tbody = document.getElementById('tbody');
      const dateInfo = document.getElementById('dateInfo');

      const displayStr = AVAILABLE_DATES.find(d => d.iso === CURRENT_DATE_ISO)?.display || CURRENT_DATE_ISO;
      dateInfo.textContent = `è³‡æ–™æ—¥æœŸï¼š${displayStr}ï¼ˆå…± ${TOP10_DATA.length} åï¼‰`;

      tbody.innerHTML = TOP10_DATA.map((item, index) => {
        const rank = index + 1;
        const rankClass = rank <= 3 ? 'rank top3' : 'rank';
        const feeText = item.avgFee !== null ? `${item.avgFee.toFixed(2)}%` : '-';
        return `
          <tr>
            <td><div class="${rankClass}">${rank}</div></td>
            <td><strong>${item.code}</strong></td>
            <td>${item.name || '-'}</td>
            <td style="text-align: right;" class="qty">${nf.format(item.totalQty)}</td>
            <td style="text-align: right;" class="fee">${feeText}</td>
            <td style="text-align: center; font-size: 12px; color: #666;">${item.sourcesText}</td>
          </tr>
        `;
      }).join('');

      document.getElementById('loadingMsg').style.display = 'none';
      document.getElementById('tableSection').style.display = 'block';
    }

    // åŒ¯å‡º CSVï¼ˆå¸¶å…¥ç›®å‰é¸å®šæ—¥æœŸï¼‰
    function exportCSV() {
      if (TOP10_DATA.length === 0) {
        showAlert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™', 'error');
        return;
      }
      const header = ['æ’å', 'è­‰åˆ¸ä»£è™Ÿ', 'è­‰åˆ¸åç¨±', 'å€Ÿåˆ¸è‚¡æ•¸', 'å¹³å‡è²»ç‡(%)', 'ä¾†æº'];
      const rows = TOP10_DATA.map((item, index) => [
        index + 1,
        item.code,
        item.name || '',
        item.totalQty,
        item.avgFee !== null ? item.avgFee.toFixed(2) : '',
        item.sourcesText
      ]);
      const csv = [
        header.join(','),
        ...rows.map(row => 
          row.map(cell => 
            typeof cell === 'string' && cell.includes(',') 
              ? `"${cell.replace(/"/g, '""')}"` 
              : cell
          ).join(',')
        )
      ].join('\n');

      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const displayStr = AVAILABLE_DATES.find(d => d.iso === CURRENT_DATE_ISO)?.display?.replace(/[\/å¹´æœˆ]/g,'-').replace(/æ—¥/,'') || CURRENT_DATE_ISO;
      a.download = `ç•¶æ²–åˆ¸å·®Top10_${displayStr}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      showAlert('å·²åŒ¯å‡º CSV æª”æ¡ˆ', 'success');
    }

    // å»ºç«‹æ—¥æœŸä¸‹æ‹‰
    function buildDateSelect() {
      const sel = document.getElementById('dateSelect');
      sel.innerHTML = AVAILABLE_DATES.map(d => 
        `<option value="${d.iso}">${d.display}</option>`
      ).join('');
      sel.value = CURRENT_DATE_ISO;
      sel.onchange = () => {
        CURRENT_DATE_ISO = sel.value;
        computeTop10ByDate(CURRENT_DATE_ISO);
        renderTable();
      };
    }

    // ä¸»è¦æµç¨‹ï¼šæŠ“â†’è§£æâ†’å»ºæ—¥æœŸæ¸…å–®â†’é è¨­æœ€æ–°â†’æ¸²æŸ“
    async function loadData() {
      document.getElementById('loadingMsg').style.display = 'block';
      document.getElementById('tableSection').style.display = 'none';

      try {
        const [tpexHTML, twseHTML] = await Promise.all([
          fetchHTML(URL_TPEX),
          fetchHTML(URL_TWSE)
        ]);
        const tpexRows = parseFeeTable(tpexHTML, 'TPEx');
        const twseRows = parseFeeTable(twseHTML, 'TWSE');
        ALL_ROWS = [...tpexRows, ...twseRows];

        if (!ALL_ROWS.length) throw new Error('æœªå–å¾—ä»»ä½•è³‡æ–™');

        // è’é›†æ‰€æœ‰å¯ç”¨æ—¥æœŸ
        const dateSet = new Map(); // iso -> display
        for (const r of ALL_ROWS) {
          if (r.dateISO) dateSet.set(r.dateISO, r.date); // ç”¨åŸå§‹åˆ¸å·®æ—¥æœŸå­—ä¸²ç•¶ display
        }
        AVAILABLE_DATES = Array
          .from(dateSet.entries())
          .map(([iso, display]) => ({ iso, display }))
          .sort((a,b) => a.iso < b.iso ? 1 : -1); // ç”±æ–°åˆ°èˆŠ

        if (!AVAILABLE_DATES.length) throw new Error('æ‰¾ä¸åˆ°æœ‰æ•ˆæ—¥æœŸ');

        // é è¨­é¸æœ€æ–°
        CURRENT_DATE_ISO = AVAILABLE_DATES[0].iso;

        // é‡ç®—ä¸¦æ¸²æŸ“
        computeTop10ByDate(CURRENT_DATE_ISO);
        buildDateSelect();
        renderTable();
        updateClock();

        showAlert(`è¼‰å…¥æˆåŠŸï¼å…± ${ALL_ROWS.length} ç­†åŸå§‹åˆ—ï¼Œæ—¥æœŸæ•¸ï¼š${AVAILABLE_DATES.length}`, 'success');
      } catch (e) {
        console.error(e);
        showAlert('è¼‰å…¥å¤±æ•—ï¼š' + e.message, 'error');
        document.getElementById('loadingMsg').innerHTML = '<div style="color: #c62828;">âŒ è¼‰å…¥å¤±æ•—</div>';
      }
    }

    // ç¶å®šäº‹ä»¶
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('btnRefresh').addEventListener('click', loadData);
      document.getElementById('btnExport').addEventListener('click', exportCSV);
      loadData(); // è‡ªå‹•è¼‰å…¥ä¸€æ¬¡
    });
  </script>
</body>
</html>
