<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>美食食譜瀏覽</title>

    <!-- 外掛：PapaParse 供 CSV 解析 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" defer></script>

    <!-- 你的樣式 -->
    <link rel="stylesheet" href="style.css" />

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
</head>

<body>
    <header class="topbar">
        <div class="brand">食譜 WebApp</div>
        <div class="actions">
            <button id="btnPickFolder" class="btn btn-accent" type="button">選擇資料夾</button>
            <button id="btnWriteCSV" class="btn btn-accent" type="button">寫入 recipes.csv</button>
            <button id="btnExport" class="btn btn-accent" type="button">匯出 CSV</button>
        </div>
    </header>

    <div class="container">
        <header>
            <h1>🍳 美食食譜瀏覽</h1>
            <p class="subtitle">探索美味食譜，享受料理時光</p>
            <nav class="nav-tabs">
                <button class="nav-btn active" data-page="browse" type="button">📖 瀏覽食譜</button>
                <button class="nav-btn" data-page="add" type="button">➕ 新增食譜</button>
            </nav>
        </header>

        <!-- 瀏覽區 -->
        <div class="page active" id="browsePage">
            <div class="filters">
                <div class="filter-row">
                    <input type="text" id="searchInput" placeholder="🔍 搜尋食譜、食材或標籤..." />
                    <select id="categorySelect">
                        <option value="">📋 全部分類</option>
                    </select>
                    <div class="view-toggle">
                        <button class="view-btn active" data-view="grid" type="button">網格</button>
                        <button class="view-btn" data-view="list" type="button">列表</button>
                    </div>
                </div>
            </div>

            <div class="stats" id="stats">載入中...</div>

            <div id="recipesContainer" class="recipes-grid">
                <div class="loading">正在載入食譜資料</div>
            </div>
        </div>

        <!-- 新增區 -->
        <div class="page" id="addPage">
            <div class="add-recipe-form">
                <div class="success-message" id="successMessage">✅ 食譜新增成功！</div>

                <form id="addRecipeForm">
                    <div class="form-section">
                        <h3>📝 基本資訊</h3>
                        <div class="form-group">
                            <label for="recipeTitle">食譜名稱 *</label>
                            <input type="text" id="recipeTitle" required placeholder="例如：番茄肉醬義大利麵" />
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="recipeCategory">分類</label>
                                <select id="recipeCategory">
                                    <option value="">選擇分類</option>
                                    <option value="主食">主食</option>
                                    <option value="中式">中式</option>
                                    <option value="日式">日式</option>
                                    <option value="韓式">韓式</option>
                                    <option value="西式">西式</option>
                                    <option value="泰式">泰式</option>
                                    <option value="湯品">湯品</option>
                                    <option value="沙拉">沙拉</option>
                                    <option value="甜點">甜點</option>
                                    <option value="飲品">飲品</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="recipeServings">份量</label>
                                <input type="number" id="recipeServings" min="1" placeholder="人份" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="prepTime">準備時間（分鐘）</label>
                                <input type="number" id="prepTime" min="0" placeholder="15" />
                            </div>
                            <div class="form-group">
                                <label for="cookTime">烹飪時間（分鐘）</label>
                                <input type="number" id="cookTime" min="0" placeholder="30" />
                            </div>
                            <div class="form-group">
                                <label for="calories">熱量（卡路里）</label>
                                <input type="number" id="calories" min="0" placeholder="500" />
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>🏷️ 標籤</h3>
                        <div class="tags-input">
                            <input type="text" id="tagsInput" placeholder="輸入標籤後按 Enter（例如：家常菜）" />
                            <div class="tags-display" id="tagsDisplay"></div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>🥬 食材清單</h3>
                        <div class="ingredients-list" id="ingredientsList">
                            <div class="ingredient-item">
                                <input type="text" placeholder="例如：義大利麵 200g" required />
                                <button type="button" class="remove-btn"
                                    onclick="app.removeIngredient(this)">移除</button>
                            </div>
                        </div>
                        <button type="button" class="add-btn" onclick="app.addIngredient()">➕ 新增食材</button>
                    </div>

                    <div class="form-section">
                        <h3>👨‍🍳 製作步驟</h3>
                        <div class="steps-list" id="stepsList">
                            <div class="step-item">
                                <span style="font-weight: bold; min-width: 30px;">1.</span>
                                <input type="text" placeholder="詳細描述第一個步驟" required />
                                <button type="button" class="remove-btn" onclick="app.removeStep(this)">移除</button>
                            </div>
                        </div>
                        <button type="button" class="add-btn" onclick="app.addStep()">➕ 新增步驟</button>
                    </div>

                    <div class="form-section">
                        <h3>🖼️ 上傳圖片（選填）</h3>
                        <div class="form-group">
                            <label for="recipeImageFile">選擇圖片檔案</label>
                            <input type="file" id="recipeImageFile" accept="image/*" />
                            <div id="addImagePreview" style="margin-top: 12px;"></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="app.clearForm()">清空表單</button>
                        <button type="submit" class="btn btn-primary">💾 儲存食譜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 你的腳本 -->
    <script src="data.js" defer></script>
    <script src="app.js" defer></script>

    <aside id="editDrawer" class="drawer hidden" aria-hidden="true">
        <div class="drawer-header">
            <h3>編輯食譜</h3>
            <button id="closeDrawer" class="btn btn-secondary" type="button">關閉</button>
        </div>
        <form id="editForm" class="edit-form">
            <label>標題</label>
            <input name="title" type="text" required>
            <label>分類</label>
            <input name="category" type="text">
            <label>標籤（分號分隔）</label>
            <input name="tags" type="text">
            <label>食材（每項以 | 分隔）</label>
            <textarea name="ingredients" rows="3"></textarea>
            <label>步驟（多行）</label>
            <textarea name="steps" rows="5"></textarea>
            <div class="grid-2">
                <div>
                    <label>準備（分鐘）</label>
                    <input name="prep_minutes" type="number" min="0">
                </div>
                <div>
                    <label>烹調（分鐘）</label>
                    <input name="cook_minutes" type="number" min="0">
                </div>
            </div>
            <div class="grid-2">
                <div>
                    <label>份量</label>
                    <input name="servings" type="number" min="1">
                </div>
                <div>
                    <label>卡路里</label>
                    <input name="calories" type="number" min="0">
                </div>
            </div>
            <label>圖片網址或上傳新圖片</label>
            <!-- 改為 text，容許相對路徑 / dataURL / blob: ObjectURL -->
            <input name="image_url" type="text" placeholder="現有圖片網址或相對路徑">
            <input id="imageFile" name="image_file" type="file" accept="image/*">
            <div id="imagePreview" style="margin:8px 0;"></div>
            <div class="drawer-actions">
                <!-- 避免預設 submit 造成整頁重整 -->
                <button id="saveRecipe" class="btn" type="button">儲存</button>
                <button id="deleteRecipe" class="btn btn-danger" type="button">刪除</button>
            </div>
        </form>
    </aside>

    <script>
        (function () {
            function registerSW() {
                if ("serviceWorker" in navigator) {
                    // 確保你的專案中存在 / 同名的 sw.js
                    navigator.serviceWorker.register("./sw.js").catch(console.error);
                }
            }
            function onceReady(fn) {
                if (document.readyState !== "loading") fn();
                else document.addEventListener("DOMContentLoaded", fn);
            }
            onceReady(registerSW);
        })();

        // 可及性友善：示範如何同步 aria-hidden（你的 app.js 也能呼叫）
        window.drawerA11y = {
            open() {
                const d = document.getElementById('editDrawer');
                d.classList.remove('hidden');
                d.setAttribute('aria-hidden', 'false');
            },
            close() {
                const d = document.getElementById('editDrawer');
                d.classList.add('hidden');
                d.setAttribute('aria-hidden', 'true');
            }
        };
    </script>
</body>

</html>