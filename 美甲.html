<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bloom Nails｜美甲沙龍</title>

    <!-- 字體：標題用優雅手寫感，內文用高可讀性無襯線字體 -->
    <link
        href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Noto+Sans+TC:wght@300;400;500;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* ======== 色彩主題：柔和、療癒 ======== */
            --pink: #f6c9d5;
            /* 粉色 */
            --nude: #e8d7c8;
            /* 奶茶色 */
            --ivory: #fff8f2;
            /* 米白 */
            --rose-gold: #b76e79;
            /* 金屬玫瑰金（點綴） */
            --ink: #3b3b3b;
            /* 文字深灰 */
            --muted: #7a7a7a;
            /* 次要文字 */
            --shadow: 0 8px 28px rgba(0, 0, 0, .08);
            --radius: 18px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
            color: var(--ink);
            background: linear-gradient(180deg, #fff 0%, var(--ivory) 100%);
        }

        a {
            color: var(--rose-gold);
            text-decoration: none;
        }

        img {
            max-width: 100%;
            display: block;
        }

        /* ======== 頁首導覽 ======== */
        .nav {
            position: sticky;
            top: 0;
            z-index: 20;
            backdrop-filter: blur(8px);
            background: rgba(255, 255, 255, .7);
            border-bottom: 1px solid rgba(0, 0, 0, .04);
        }

        .nav-inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .brand-title {
            font-family: 'Great Vibes', cursive;
            font-size: 32px;
            color: var(--rose-gold);
            letter-spacing: .5px;
        }

        .brand-sub {
            color: var(--muted);
            font-size: 12px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .nav-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            border: none;
            cursor: pointer;
            border-radius: 999px;
            padding: 10px 16px;
            font-weight: 600;
            transition: transform .08s ease, box-shadow .2s ease, background .2s ease;
        }

        .btn-primary {
            background: var(--rose-gold);
            color: #fff;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
        }

        .btn-ghost {
            background: transparent;
            color: var(--rose-gold);
            border: 1px solid var(--rose-gold);
        }

        /* ======== Hero 區塊 ======== */
        .hero {
            max-width: 1100px;
            margin: 28px auto;
            padding: 24px;
            display: grid;
            gap: 20px;
            grid-template-columns: 1.1fr .9fr;
            align-items: center;
        }

        .hero-card {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 28px;
            position: relative;
            overflow: hidden;
        }

        .hero-badge {
            position: absolute;
            top: 18px;
            left: 18px;
            font-size: 12px;
            letter-spacing: 2px;
            color: #fff;
            background: linear-gradient(135deg, var(--rose-gold), #d9939c);
            padding: 6px 10px;
            border-radius: 999px;
        }

        .hero-title {
            font-family: 'Great Vibes', cursive;
            font-size: 48px;
            color: var(--rose-gold);
            margin: 10px 0 6px;
        }

        .hero-sub {
            color: var(--muted);
            line-height: 1.8;
        }

        .hero-cta {
            display: flex;
            gap: 12px;
            margin-top: 18px;
            flex-wrap: wrap;
        }

        .hero-media {
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
            box-shadow: var(--shadow);
            background: #f4f0ee;
        }

        .hero-media img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            aspect-ratio: 4/5;
            filter: contrast(1.02) saturate(1.02);
        }

        .hero-caption {
            position: absolute;
            right: 14px;
            bottom: 14px;
            font-size: 12px;
            color: rgba(0, 0, 0, .5);
        }

        /* ======== 服務卡片 ======== */
        .section {
            max-width: 1100px;
            margin: 28px auto;
            padding: 0 24px;
        }

        .section h2 {
            font-size: 28px;
            margin: 10px 0 18px;
        }

        .cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .card {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card img {
            aspect-ratio: 4/3;
            object-fit: cover;
        }

        .card-body {
            padding: 16px;
            display: grid;
            gap: 8px;
        }

        .card-title {
            font-weight: 700;
        }

        .pill {
            display: inline-block;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 999px;
            background: var(--ivory);
            color: var(--rose-gold);
            border: 1px solid #efd6d9;
        }

        .price {
            font-weight: 700;
            color: var(--rose-gold);
        }

        /* ======== 作品展示牆 ======== */
        .masonry {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .gallery-item {
            position: relative;
            overflow: hidden;
            border-radius: 14px;
            box-shadow: var(--shadow);
            background: #fff;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            aspect-ratio: 1/1;
            transition: transform .4s ease;
        }

        .gallery-item:hover img {
            transform: scale(1.04);
        }

        .gallery-meta {
            position: absolute;
            left: 8px;
            bottom: 8px;
            background: rgba(255, 255, 255, .85);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 12px;
            color: var(--rose-gold);
        }

        /* ======== 預約系統（前端最小可行，含剩餘名額顯示） ======== */
        .booking {
            display: grid;
            grid-template-columns: 1.1fr .9fr;
            gap: 16px;
            align-items: start;
        }

        .panel {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 16px;
        }

        .panel h3 {
            margin: 6px 0 12px;
        }

        .form {
            display: grid;
            gap: 12px;
        }

        .field {
            display: grid;
            gap: 6px;
        }

        .input,
        .select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid #e8e2df;
            background: #fff;
            outline: none;
            font-size: 14px;
        }

        .hint {
            color: var(--muted);
            font-size: 12px;
        }

        .slots {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 6px;
        }

        .slot {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid #ead4d8;
            background: #fff;
            color: #70444b;
            cursor: pointer;
        }

        .slot[disabled] {
            opacity: .4;
            pointer-events: none;
        }

        .availability {
            display: grid;
            gap: 10px;
        }

        .availability-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            border: 1px dashed #ecdede;
        }

        .availability-item strong {
            color: #5a2e35;
        }

        .socials {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .social-link {
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid #ead4d8;
            color: #5a2e35;
            background: #fff;
        }

        .footer {
            text-align: center;
            color: var(--muted);
            font-size: 12px;
            padding: 40px 10px;
        }

        /* ======== RWD ======== */
        @media (max-width: 960px) {
            .hero {
                grid-template-columns: 1fr;
            }

            .booking {
                grid-template-columns: 1fr;
            }

            .cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .masonry {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 640px) {
            .cards {
                grid-template-columns: 1fr;
            }

            .masonry {
                grid-template-columns: repeat(2, 1fr);
            }

            .hero-title {
                font-size: 42px;
            }
        }
    </style>
</head>

<body>
    <!-- ======== 導覽列（含快速預約 CTA） ======== -->
    <header class="nav">
        <div class="nav-inner">
            <div class="brand">
                <div class="brand-title">Bloom Nails</div>
                <div class="brand-sub">NAIL ATELIER</div>
            </div>
            <div class="nav-actions">
                <a class="btn btn-ghost" href="#gallery">作品集</a>
                <a class="btn btn-primary" href="https://thomastsao0704.github.io/WebApp/App27/reserve.html">立即預約</a>
            </div>
        </div>
    </header>

    <!-- ======== Hero 區：大圖 + 標語 + 立即預約 ======== -->
    <section class="hero" id="hero">
        <article class="hero-card">
            <span class="hero-badge">NEW • 秋冬質感系</span>
            <h1 class="hero-title">讓指尖，說你的故事</h1>
            <p class="hero-sub">專注於日式手繪、法式極簡與延甲造型。以醫療級消毒流程、低敏膠材與細膩雕琢，呈現最貼合你氣質的專屬設計。</p>
            <div class="hero-cta">
                <a class="btn btn-primary" href="#booking">立即預約</a>
                <a class="btn btn-ghost" href="#services">查看服務</a>
            </div>
        </article>
        <figure class="hero-media">
            <!-- 圖片風格建議：純色／微模糊背景 + 高解析近拍手模；此處用佔位圖，請替換為實際作品照 -->
            <img src="./img/484920.jpg"
                alt="高質感美甲近拍" loading="lazy">
            <figcaption class="hero-caption">Photo by Unsplash • 手模近拍</figcaption>
        </figure>
    </section>

    <!-- ======== 服務卡片：清楚呈現服務／時間／價格 ======== -->
    <section class="section" id="services">
        <h2>服務與方案</h2>
        <div class="cards">
            <div class="card">
                <img src="./img/01.jpg"
                    alt="日常素色凝膠" loading="lazy">
                <div class="card-body">
                    <div class="card-title">日常素色凝膠</div>
                    <div class="hint">清透／奶茶／莫蘭迪系</div>
                    <div class="hint"><span class="pill">60–75 分鐘</span></div>
                    <div class="price">NT$ 1,200 起</div>
                </div>
            </div>
            <div class="card">
                <img src="./img/02.jpg"
                    alt="日式手繪設計" loading="lazy">
                <div class="card-body">
                    <div class="card-title">日式手繪設計</div>
                    <div class="hint">細節拉花／跳色拼接</div>
                    <div class="hint"><span class="pill">90–120 分鐘</span></div>
                    <div class="price">NT$ 1,800 起</div>
                </div>
            </div>
            <div class="card">
                <img src="./img/03.jpg"
                    alt="延甲造型" loading="lazy">
                <div class="card-body">
                    <div class="card-title">延甲造型</div>
                    <div class="hint">自然甲型／水滴光澤</div>
                    <div class="hint"><span class="pill">120–150 分鐘</span></div>
                    <div class="price">NT$ 2,600 起</div>
                </div>
            </div>
        </div>
    </section>

    <!-- ======== 作品展示牆：分類標籤可日後擴充 ======== -->
    <section class="section" id="gallery">
        <h2>作品展示牆</h2>
        <div class="masonry">
            <!-- 提示：將下列圖片換成你的實際作品照，並維持簡約背景風格以保持一致性 -->
            <div class="gallery-item">
                <img src="./img/04.jpg"
                    alt="奶茶系素色">
                <div class="gallery-meta">奶茶素色</div>
            </div>
            <div class="gallery-item">
                <img src="https://images.unsplash.com/photo-1541643600914-78b084683601?q=80&w=800&auto=format&fit=crop"
                    alt="莫蘭迪跳色">
                <div class="gallery-meta">莫蘭迪</div>
            </div>
            <div class="gallery-item">
                <img src="./img/05.jpg"
                    alt="法式極簡">
                <div class="gallery-meta">法式極簡</div>
            </div>
            <div class="gallery-item">
                <img src="./img/07.jpg"
                    alt="手繪細節">
                <div class="gallery-meta">手繪細節</div>
            </div>
            <div class="gallery-item">
                <img src="https://images.unsplash.com/photo-1522335789203-aabd1fc54bc9?q=80&w=800&auto=format&fit=crop"
                    alt="派對亮片">
                <div class="gallery-meta">派對亮片</div>
            </div>
            <div class="gallery-item">
                <img src="./img/08.jpg"
                    alt="自然延甲">
                <div class="gallery-meta">自然延甲</div>
            </div>
            <div class="gallery-item">
                <img src="./img/09.jpg"
                    alt="柔霧粉">
                <div class="gallery-meta">柔霧粉</div>
            </div>
            <div class="gallery-item">
                <img src="./img/10.jpg"
                    alt="光療漸層">
                <div class="gallery-meta">漸層</div>
            </div>
        </div>
    </section>

    <!-- ======== 預約系統：LINE／Messenger 串接 + Google 行事曆連結 + 剩餘名額 ======== -->
    <section class="section" id="booking">
        <h2>線上預約</h2>
        <div class="booking">
            <!-- 左側：填表與操作 -->
            <div class="panel">
                <h3>選擇時段</h3>
                <form id="bookingForm" class="form">
                    <!-- 使用者名稱（方便門市辨識） -->
                    <div class="field">
                        <label for="name">姓名</label>
                        <input class="input" id="name" name="name" placeholder="例：陳小美" required>
                    </div>

                    <!-- 日期選擇：限制為今天起 30 天內 -->
                    <div class="field">
                        <label for="date">日期</label>
                        <input class="input" type="date" id="date" name="date" required>
                        <div class="hint">可預約區間：今日起 30 天內</div>
                    </div>

                    <!-- 時段：以常見三段為例，可依營運調整 -->
                    <div class="field">
                        <label>可預約時段（點擊選取）</label>
                        <div class="slots" id="slotList">
                            <!-- 動態生成，如：10:00｜13:30｜16:00 -->
                        </div>
                        <input type="hidden" id="time" name="time" required>
                    </div>

                    <!-- 設計師／服務類型：簡化版下拉 -->
                    <div class="field">
                        <label for="artist">設計師</label>
                        <select class="select" id="artist" name="artist" required>
                            <option value="Mina">Mina（擅長日式手繪）</option>
                            <option value="Yuri">Yuri（擅長素色質感）</option>
                            <option value="Rei">Rei（擅長延甲造型）</option>
                        </select>
                    </div>

                    <div class="field">
                        <label for="service">服務項目</label>
                        <select class="select" id="service" name="service" required>
                            <option value="素色凝膠">日常素色凝膠</option>
                            <option value="手繪設計">日式手繪設計</option>
                            <option value="延甲造型">延甲造型</option>
                        </select>
                    </div>

                    <!-- 送出預約：會在本地儲存並更新剩餘名額；同時產生 Google Calendar 連結 -->
                    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
                        <button type="submit" class="btn btn-primary">送出預約</button>
                        <a id="gcalLink" class="btn btn-ghost" target="_blank" rel="noopener">加入 Google 行事曆</a>
                    </div>

                    <!-- 社群串接：LINE／Messenger 直接交談（請換成你的官方帳號） -->
                    <div class="field">
                        <label>需要人工協助？</label>
                        <div class="socials">
                            <!-- 將 @yourlineid 換成你的 LINE 官方帳號 ID -->
                            <a class="social-link" href="https://line.me/R/ti/p/@yourlineid" target="_blank"
                                rel="noopener">LINE 官方帳號</a>
                            <!-- 將 yourpage 換成你的粉專短網址 -->
                            <a class="social-link" href="https://m.me/yourpage" target="_blank" rel="noopener">Facebook
                                Messenger</a>
                        </div>
                    </div>

                    <!-- Demo 工具（僅示範用，正式環境可移除） -->
                    <details>
                        <summary>開發者工具（Demo）</summary>
                        <div class="hint">重置本地預約名額、查看儲存內容</div>
                        <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
                            <button type="button" class="btn btn-ghost" id="resetInventory">重置今日與未來名額</button>
                            <button type="button" class="btn btn-ghost" id="clearAll">清空全部預約資料</button>
                        </div>
                    </details>
                </form>
            </div>

            <!-- 右側：剩餘名額即時顯示（稀缺感） -->
            <aside class="panel">
                <h3>本日剩餘名額</h3>
                <div id="availability" class="availability">
                    <!-- 動態產生：顯示每個時段剩餘位數，例如 10:00（剩 2 位） -->
                </div>
                <p class="hint">※ 名額以實際確認為準；線上預約成立後將以訊息通知。</p>
            </aside>
        </div>
    </section>

    <footer class="footer">© <span id="year"></span> Bloom Nails. All rights reserved.</footer>
    <!-- ======== 店主後台（僅限管理者） ======== -->
    <section class="section" id="admin">
        <h2>店主後台</h2>
        <div class="booking">
            <div class="panel">
                <h3>管理名額與時段</h3>
                <div class="form">
                    <div class="field">
                        <label for="adminPin">管理者 PIN</label>
                        <input class="input" id="adminPin" placeholder="輸入後台 PIN（僅你知道）" type="password" />
                        <div class="hint">＊請先在 GAS 的 Script Properties 設定 ADMIN_PIN</div>
                    </div>
                    <div class="field">
                        <label for="adminDate">日期</label>
                        <input class="input" type="date" id="adminDate" />
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-ghost" id="btnAdminLoad">載入當日時段</button>
                        <button class="btn btn-primary" id="btnAdminSave">批次儲存變更</button>
                    </div>
                    <div id="adminSlotsBox" class="availability" style="margin-top:10px;"></div>
                </div>
            </div>

            <aside class="panel">
                <h3>手動加單</h3>
                <div class="form">
                    <div class="field"><label>姓名</label><input class="input" id="mName" placeholder="例：王小美"></div>
                    <div class="field"><label>日期</label><input class="input" type="date" id="mDate"></div>
                    <div class="field"><label>時段</label>
                        <select class="select" id="mTime">
                            <option>10:00</option>
                            <option>13:30</option>
                            <option>16:00</option>
                        </select>
                    </div>
                    <div class="field"><label>設計師</label>
                        <select class="select" id="mArtist">
                            <option>Mina</option>
                            <option>Yuri</option>
                            <option>Rei</option>
                        </select>
                    </div>
                    <div class="field"><label>服務</label>
                        <select class="select" id="mService">
                            <option>素色凝膠</option>
                            <option>手繪設計</option>
                            <option>延甲造型</option>
                        </select>
                    </div>
                    <div class="field" style="display:flex; gap:8px; align-items:center;">
                        <input type="checkbox" id="mForce" /> <label for="mForce">忽略庫存強制加單</label>
                    </div>
                    <button class="btn btn-primary" id="btnManualAdd">新增預約</button>
                </div>
            </aside>
        </div>
    </section>
    <script>
        /* ================================================================
           預約系統（前端最小可行版本）
           - 以 localStorage 作為示範資料儲存，不需後端即可測試流程
           - 透過「名額庫存表」實作「剩餘名額顯示」與「時段可用性」
           - 產生 Google Calendar 事件連結（方便客人加到行事曆）
           - 正式上線時，建議改為後端 API（GAS / Firebase / 自架）
           ================================================================ */

        // ---- 可調整參數 ----
        const SLOT_TEMPLATE = ["10:00", "13:30", "16:00"];  // 一天 3 個時段
        const CAPACITY_PER_SLOT = 3;                           // 每時段可預約人數
        const BOOKABLE_DAYS = 30;                              // 可預約 30 天內

        // localStorage key
        const KEY_INVENTORY = 'nail_inventory_v1';   // { 'YYYY-MM-DD': { '10:00': 剩餘名額, ... } }
        const KEY_APPTS = 'nail_appointments_v1';   // 預約紀錄陣列

        // DOM 參考
        const dateInput = document.getElementById('date');
        const slotList = document.getElementById('slotList');
        const timeHidden = document.getElementById('time');
        const availabilityBox = document.getElementById('availability');
        const gcalLink = document.getElementById('gcalLink');

        // 年份
        document.getElementById('year').textContent = new Date().getFullYear();

        // 初始化日期（今日）與限制區間（今日～30 天內）
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;

        dateInput.min = todayStr;
        const maxDate = new Date(today); maxDate.setDate(maxDate.getDate() + BOOKABLE_DAYS);
        const maxStr = `${maxDate.getFullYear()}-${String(maxDate.getMonth() + 1).padStart(2, '0')}-${String(maxDate.getDate()).padStart(2, '0')}`;
        dateInput.max = maxStr;
        dateInput.value = todayStr;

        // 工具：讀／寫 localStorage
        function readJSON(key, fallback) {
            try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; }
        }
        function writeJSON(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

        // 初始化指定日期的名額庫存
        function ensureInventory(dateStr) {
            const inv = readJSON(KEY_INVENTORY, {});
            if (!inv[dateStr]) {
                inv[dateStr] = Object.fromEntries(SLOT_TEMPLATE.map(t => [t, CAPACITY_PER_SLOT]));
                writeJSON(KEY_INVENTORY, inv);
            }
            return inv;
        }

        // 取得某日剩餘名額映射
        function getSlotsForDate(dateStr) {
            const inv = ensureInventory(dateStr);
            return inv[dateStr];
        }

        // 減少庫存
        function consumeSlot(dateStr, timeStr) {
            const inv = ensureInventory(dateStr);
            if (inv[dateStr][timeStr] > 0) {
                inv[dateStr][timeStr] -= 1;
                writeJSON(KEY_INVENTORY, inv);
                return true;
            }
            return false;
        }

        // 顯示可選時段按鈕（依剩餘名額決定可否點擊）
        function renderSlots(dateStr) {
            const slots = getSlotsForDate(dateStr);
            slotList.innerHTML = '';
            timeHidden.value = '';
            Object.entries(slots).forEach(([time, remain]) => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'slot';
                btn.textContent = remain > 0 ? `${time}（剩 ${remain} 位）` : `${time}（已滿）`;
                if (remain === 0) btn.setAttribute('disabled', 'disabled');
                btn.addEventListener('click', () => {
                    timeHidden.value = time;
                    // 視覺回饋：選中狀態
                    [...slotList.children].forEach(el => el.style.outline = 'none');
                    btn.style.outline = '2px solid #dba3ab';
                });
                slotList.appendChild(btn);
            });
        }

        // 右側：本日剩餘名額清單（僅示範顯示今日）
        function renderAvailability() {
            const slots = getSlotsForDate(dateInput.value);
            availabilityBox.innerHTML = '';
            Object.entries(slots).forEach(([time, remain]) => {
                const row = document.createElement('div');
                row.className = 'availability-item';
                row.innerHTML = `<div><strong>${time}</strong></div><div>剩餘 <strong>${remain}</strong> 位</div>`;
                availabilityBox.appendChild(row);
            });
        }

        // 產生 Google Calendar 事件連結（以 90 分鐘為例，可依服務調整）
        function makeGoogleCalLink({ title, details, startISO, endISO }) {
            const url = new URL('https://www.google.com/calendar/render');
            url.searchParams.set('action', 'TEMPLATE');
            url.searchParams.set('text', title);
            url.searchParams.set('details', details);
            url.searchParams.set('dates', `${startISO.replace(/[-:]/g, '').replace('.000', '').replace(/\+.*$/, 'Z')}/${endISO.replace(/[-:]/g, '').replace('.000', '').replace(/\+.*$/, 'Z')}`);
            return url.toString();
        }

        function buildEventTimes(dateStr, timeStr, minutes = 90) {
            // 將 YYYY-MM-DD 與 HH:mm 轉為 ISO 字串（以使用者本地時區計算）
            const [y, m, d] = dateStr.split('-').map(Number);
            const [hh, mm] = timeStr.split(':').map(Number);
            const start = new Date(y, m - 1, d, hh, mm);
            const end = new Date(start.getTime() + minutes * 60000);
            return { startISO: start.toISOString(), endISO: end.toISOString() };
        }

        // 表單送出：寫入預約、更新名額、給予行事曆連結
        document.getElementById('bookingForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const dateStr = document.getElementById('date').value;
            const timeStr = document.getElementById('time').value;
            const artist = document.getElementById('artist').value;
            const service = document.getElementById('service').value;
            if (!timeStr) { alert('請先選擇一個時段'); return; }

            // 嘗試扣庫存
            const ok = consumeSlot(dateStr, timeStr);
            if (!ok) { alert('此時段已滿，請改選其他時段'); renderSlots(dateStr); renderAvailability(); return; }

            // 寫入預約紀錄
            const appts = readJSON(KEY_APPTS, []);
            const { startISO, endISO } = buildEventTimes(dateStr, timeStr, service === '延甲造型' ? 120 : (service === '手繪設計' ? 120 : 90));
            const record = { name, date: dateStr, time: timeStr, artist, service, startISO, endISO, createdAt: new Date().toISOString() };
            appts.push(record);
            writeJSON(KEY_APPTS, appts);

            // 更新 UI
            renderSlots(dateStr);
            renderAvailability();

            // 行事曆連結更新
            const title = `${service}（${artist}）｜Bloom Nails`;
            const details = `客人：${name}\n時間：${dateStr} ${timeStr}\n地點：Bloom Nails（請提前 5 分鐘報到）`;
            gcalLink.href = makeGoogleCalLink({ title, details, startISO, endISO });
            gcalLink.textContent = '已建立：加入 Google 行事曆';

            alert('預約送出成功！我們將盡快與您確認。');
        });

        // 日期變更時，重繪時段與可用名額
        dateInput.addEventListener('change', () => {
            ensureInventory(dateInput.value);
            renderSlots(dateInput.value);
            renderAvailability();
            gcalLink.textContent = '加入 Google 行事曆';
            gcalLink.removeAttribute('href');
        });

        // Demo：重置庫存與清空資料
        document.getElementById('resetInventory').addEventListener('click', () => {
            const inv = readJSON(KEY_INVENTORY, {});
            // 今日起 30 天
            for (let i = 0; i <= BOOKABLE_DAYS; i++) {
                const d = new Date(); d.setDate(d.getDate() + i);
                const ds = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                inv[ds] = Object.fromEntries(SLOT_TEMPLATE.map(t => [t, CAPACITY_PER_SLOT]));
            }
            writeJSON(KEY_INVENTORY, inv);
            renderSlots(dateInput.value); renderAvailability();
            alert('名額已重置！');
        });

        document.getElementById('clearAll').addEventListener('click', () => {
            localStorage.removeItem(KEY_APPTS);
            localStorage.removeItem(KEY_INVENTORY);
            ensureInventory(dateInput.value);
            renderSlots(dateInput.value); renderAvailability();
            alert('已清空全部預約資料與名額');
        });

        // 首次載入：確保今日庫存並渲染
        ensureInventory(todayStr);
        renderSlots(todayStr);
        renderAvailability();

        // ===== 管理後台：API 封裝 =====
        async function adminFetchDay(pin, dateStr) {
            const url = `${GAS_URL}?action=admin&op=get_day&date=${encodeURIComponent(dateStr)}`;
            const res = await fetch(url, { headers: { 'X-Admin-Pin': pin } });
            const data = await res.json(); if (!data.ok) throw new Error(data.message);
            return data; // { ok:true, date, rows:[{time,capacity,remaining,closed}], slots:{...} }
        }
        async function adminSave(pin, dateStr, updates) {
            const res = await fetch(`${GAS_URL}?action=admin&op=save`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Pin': pin },
                body: JSON.stringify({ date: dateStr, updates })
            });
            const data = await res.json(); if (!data.ok) throw new Error(data.message);
            return data; // { ok:true, slots:{...} }
        }
        async function adminManualAdd(pin, payload) {
            const res = await fetch(`${GAS_URL}?action=admin&op=manual_add`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Admin-Pin': pin },
                body: JSON.stringify(payload)
            });
            const data = await res.json(); if (!data.ok) throw new Error(data.message);
            return data;
        }

        // ===== 管理後台：UI 綁定 =====
        const adminPin = document.getElementById('adminPin');
        const adminDate = document.getElementById('adminDate');
        const adminBox = document.getElementById('adminSlotsBox');

        document.getElementById('btnAdminLoad').addEventListener('click', async () => {
            if (!adminDate.value) { alert('請選擇日期'); return; }
            try {
                const data = await adminFetchDay(adminPin.value.trim(), adminDate.value);
                renderAdminEditor(data.rows);
            } catch (e) { alert(e.message); }
        });

        function renderAdminEditor(rows) {
            adminBox.innerHTML = '';
            rows.sort((a, b) => (a.time > b.time ? 1 : -1));
            rows.forEach(r => {
                const wrap = document.createElement('div');
                wrap.className = 'availability-item';
                wrap.dataset.time = r.time;
                wrap.innerHTML = `
        <div style="min-width:90px;"><strong>${r.time}</strong></div>
        <div>容量 <input type="number" min="0" value="${r.capacity}" data-role="cap" style="width:80px; padding:6px; border:1px solid #ecdede; border-radius:8px;"> 人</div>
        <div>剩餘 <input type="number" min="0" value="${r.remaining}" data-role="rem" style="width:80px; padding:6px; border:1px solid #ecdede; border-radius:8px;"> 人</div>
        <div><label style="display:flex; gap:6px; align-items:center;">
          <input type="checkbox" data-role="closed" ${r.closed ? 'checked' : ''}> 關閉時段
        </label></div>`;
                adminBox.appendChild(wrap);
            });
        }

        document.getElementById('btnAdminSave').addEventListener('click', async () => {
            if (!adminDate.value) { alert('請選擇日期'); return; }
            const pin = adminPin.value.trim();
            const updates = [...adminBox.children].map(row => ({
                time: row.dataset.time,
                capacity: Number(row.querySelector('[data-role="cap"]').value),
                remaining: Number(row.querySelector('[data-role="rem"]').value),
                closed: row.querySelector('[data-role="closed"]').checked
            }));
            try {
                const data = await adminSave(pin, adminDate.value, updates);
                // 若編輯的是顧客側目前日期，順便刷新顧客側
                if (adminDate.value === document.getElementById('date').value) {
                    renderSlotsFromMap(data.slots || {});
                    renderAvailabilityFromMap(data.slots || {});
                }
                alert('已儲存變更');
            } catch (e) { alert(e.message); }
        });

        document.getElementById('btnManualAdd').addEventListener('click', async () => {
            const pin = adminPin.value.trim();
            const payload = {
                name: document.getElementById('mName').value.trim(),
                date: document.getElementById('mDate').value,
                time: document.getElementById('mTime').value,
                artist: document.getElementById('mArtist').value,
                service: document.getElementById('mService').value,
                force: document.getElementById('mForce').checked
            };
            if (!payload.name || !payload.date || !payload.time) { alert('請填姓名/日期/時段'); return; }
            try {
                const data = await adminManualAdd(pin, payload);
                if (payload.date === document.getElementById('date').value) {
                    renderSlotsFromMap(data.slots || {});
                    renderAvailabilityFromMap(data.slots || {});
                }
                alert('已新增預約');
            } catch (e) { alert(e.message); }
        });
    </script>
</body>


</html>


