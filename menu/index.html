<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SOL Bistro - Menu</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #2c3e50;
            --bg2: #34495e;
            --gold: #d4af37;
            --card: rgba(40, 40, 40, .95);
            --text: #f0f0f0;
            --muted: #aaa;
            --line: #555;
            --ok: #7ed957;
            --warn: #ffb703;
            --danger: #ff6b6b;
            --focus: #f4d03f;
        }

        body {
            background: linear-gradient(135deg, var(--bg) 0%, var(--bg2) 100%);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            color: var(--text);
            padding: 20px;
            min-height: 100vh
        }

        .menu-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card);
            border: 3px solid var(--gold);
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, .5)
        }

        .header {
            text-align: center;
            border-bottom: 2px solid var(--gold);
            padding-bottom: 24px;
            margin-bottom: 24px
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 32px;
            margin-bottom: 12px;
            flex-wrap: wrap
        }

        .logo-title {
            font-size: 2.5em;
            font-weight: 800;
            letter-spacing: .06em
        }

        .logo-circle {
            width: 112px;
            height: 112px;
            border: 3px solid var(--text);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(60, 60, 60, .8)
        }

        .sol {
            font-size: 2.2em;
            font-weight: 800;
            line-height: 1
        }

        .bistro {
            font-size: 1.2em;
            opacity: .9
        }

        .wifi {
            background: #555;
            padding: 6px 14px;
            border-radius: 20px;
            display: inline-block;
            font-size: .9em;
            margin-top: 6px
        }

        .rules {
            font-size: .9em;
            color: #ccc;
            line-height: 1.6;
            margin-top: 10px
        }

        .tools {
            display: flex;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
            margin-top: 18px;
            flex-wrap: wrap
        }

        .language-switcher {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center
        }

        .lang-btn {
            background: rgba(60, 60, 60, .85);
            border: 2px solid #555;
            color: var(--text);
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            transition: .2s
        }

        .lang-btn:hover {
            border-color: var(--gold);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(212, 175, 55, .25)
        }

        .lang-btn[aria-pressed="true"] {
            background: linear-gradient(135deg, var(--gold), #f4d03f);
            color: #2c3e50;
            border-color: var(--gold)
        }

        .right-tools {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap
        }

        .search {
            display: flex;
            align-items: center;
            gap: 8px
        }

        .search input {
            background: #2e2e2e;
            border: 1px solid #4a4a4a;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 10px;
            min-width: 220px
        }

        .toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #2e2e2e;
            border: 1px solid #4a4a4a;
            padding: 6px 10px;
            border-radius: 10px;
            font-size: .9em
        }

        .btn {
            background: rgba(60, 60, 60, .9);
            border: 1px solid #666;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600
        }

        .btn:hover {
            border-color: var(--gold)
        }

        .btn[disabled] {
            opacity: .6;
            cursor: not-allowed
        }

        .spin {
            display: inline-block;
            transform-origin: center;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .toc {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 12px
        }

        .toc a {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px dashed #666;
            color: var(--text);
            text-decoration: none;
            font-size: .9em
        }

        .toc a:hover {
            border-color: var(--gold)
        }

        .menu-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 36px;
            margin-top: 18px
        }

        .menu-section {
            margin-bottom: 24px
        }

        .section-title {
            background: linear-gradient(to right, var(--gold), #f4d03f);
            color: #2c3e50;
            padding: 8px 14px;
            font-weight: 800;
            text-transform: uppercase;
            margin-bottom: 14px;
            clip-path: polygon(0 0, 95% 0, 100% 50%, 95% 100%, 0 100%);
            display: inline-block;
            min-width: 140px
        }

        .menu-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--line)
        }

        .item-name {
            flex: 1
        }

        .name-primary {
            font-size: 1.05em;
            font-weight: 700;
            margin-bottom: 2px
        }

        .name-secondary {
            font-size: .92em;
            color: var(--muted)
        }

        .badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 4px
        }

        .badge {
            border: 1px solid #666;
            border-radius: 8px;
            padding: 2px 6px;
            font-size: .75em;
            opacity: .95
        }

        .badge.vegan {
            border-color: var(--ok)
        }

        .badge.spicy {
            border-color: var(--warn)
        }

        .badge.allergen {
            border-color: #888
        }

        .price {
            font-weight: 800;
            white-space: nowrap;
            color: var(--gold);
            min-width: 90px;
            text-align: right
        }

        .soldout .name-primary,
        .soldout .name-secondary {
            opacity: .6;
            text-decoration: line-through
        }

        .thumb {
            width: 84px;
            height: 84px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid #444;
            background: #2a2a2a;
            flex-shrink: 0
        }

        .loading {
            grid-column: 1/-1;
            text-align: center;
            padding: 36px;
            font-size: 1.1em;
            color: var(--gold)
        }

        .loading::after {
            content: "...";
            animation: dots 1.5s steps(4, end) infinite
        }

        @keyframes dots {

            0%,
            20% {
                content: "."
            }

            40% {
                content: ".."
            }

            60%,
            100% {
                content: "..."
            }
        }

        .error {
            grid-column: 1/-1;
            background: rgba(255, 107, 107, .1);
            border: 2px solid var(--danger);
            border-radius: 10px;
            padding: 20px;
            color: var(--danger)
        }

        .error-details {
            background: rgba(0, 0, 0, .3);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: ui-monospace, Consolas, Monaco, monospace;
            font-size: .9em;
            color: #ffd700
        }

        :focus-visible {
            outline: 3px solid var(--focus);
            outline-offset: 2px;
            border-radius: 8px
        }

        @media print {
            body {
                background: white;
                padding: 0
            }

            .menu-container {
                box-shadow: none;
                border: none
            }

            .header,
            .tools,
            .toc {
                border: none
            }

            .wifi {
                display: none
            }

            .menu-content {
                grid-template-columns: 1fr 1fr
            }

            .section-title {
                clip-path: none;
                border-radius: 6px
            }

            .badge {
                border-color: #bbb;
                color: #333
            }

            .price {
                color: #000
            }
        }

        @media (max-width: 900px) {
            .menu-content {
                grid-template-columns: 1fr
            }

            .thumb {
                width: 72px;
                height: 72px
            }
        }
    </style>
</head>

<body>
    <div class="menu-container">
        <header class="header">
            <div class="logo" aria-label="SOL Bistro logo">
                <div class="logo-title">FOOD</div>
                <div class="logo-circle">
                    <div class="sol">SOL</div>
                    <div class="bistro">bistro</div>
                </div>
                <div class="logo-title">MENU</div>
            </div>
            <div class="wifi" aria-label="Wi-Fi info">🌐 FREE Wi-Fi | solbistro2018</div>
            <p class="rules" aria-label="House rules">
                ☑ No outside food or drink allowed<br />
                ☑ No playing cards<br />
                ☑ Minimum charge one drink or one meal per person<br />
                ☑ Underage drinking or smoking is not allowed
            </p>

            <div class="tools">
                <div class="language-switcher" role="tablist" aria-label="Language switcher"></div>

                <div class="right-tools">
                    <div class="search">
                        <label for="q" class="visually-hidden" style="position:absolute;left:-9999px">Search</label>
                        <input id="q" type="search" placeholder="Search / 檢索 / 検索（多語關鍵字）" />
                    </div>

                    <label class="toggle">
                        <input id="hideSoldout" type="checkbox" />
                        <span>隱藏售罄</span>
                    </label>

                    <button id="refreshBtn" class="btn" type="button" title="即時刷新（不重整頁面）">
                        <span id="refreshIcon" aria-hidden="true">🔄</span> 即時刷新
                    </button>
                </div>
            </div>

            <nav class="toc" aria-label="Categories"></nav>
        </header>

        <main id="menuContent" class="menu-content" aria-live="polite">
            <div class="loading">正在載入菜單</div>
        </main>
    </div>

    <script>
        // ===== CONFIG =====
        const API_URL = 'https://script.google.com/macros/s/AKfycbzJ1oREKuGwBccnkTFsHOZQNcb21i8JB3xtArJ5S50Pkv0N52QTc48I4rISjNLn-m6WiQ/exec';

        const CATEGORIES = [
            { name: 'SALAD', column: 'left' },
            { name: 'PAELLA', column: 'left' },
            { name: 'PASTA', column: 'left' },
            { name: 'PIZZA', column: 'left' },
            { name: 'TAPAS', column: 'right' },
            { name: 'DESSERT', column: 'right' }
        ];

        const LANGUAGES = [
            { code: 'zh', label: '中文' },
            { code: 'en', label: 'English' },
            { code: 'ja', label: '日本語' },
            { code: 'ko', label: '한국어' },
            { code: 'fr', label: 'Français' },
            { code: 'th', label: 'ไทย' },
            { code: 'fil', label: 'Filipino' },
            { code: 'vi', label: 'Tiếng Việt' }
        ];

        // ===== STATE =====
        let menuData = {};
        let currentLang = 'zh';
        let query = '';
        let hideSoldOut = false;

        // ===== INITIALIZATION =====
        function init() {
            setupLanguageSwitcher();
            setupEventListeners();
            loadMenu();
        }

        function setupLanguageSwitcher() {
            const container = document.querySelector('.language-switcher');
            LANGUAGES.forEach(lang => {
                const btn = document.createElement('button');
                btn.className = 'lang-btn';
                btn.textContent = lang.label;
                btn.setAttribute('role', 'tab');
                btn.setAttribute('aria-pressed', lang.code === currentLang);
                btn.onclick = () => switchLanguage(lang.code);
                container.appendChild(btn);
            });
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('q');
            searchInput.addEventListener('input', (e) => {
                query = e.target.value.toLowerCase().trim();
                renderMenu(menuData);
            });

            const soldoutCheckbox = document.getElementById('hideSoldout');
            soldoutCheckbox.addEventListener('change', (e) => {
                hideSoldOut = e.target.checked;
                renderMenu(menuData);
            });

            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.addEventListener('click', () => {
                refreshBtn.disabled = true;
                const icon = document.getElementById('refreshIcon');
                icon.classList.add('spin');
                loadMenu(true).finally(() => {
                    refreshBtn.disabled = false;
                    icon.classList.remove('spin');
                });
            });
        }

        function switchLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.setAttribute('aria-pressed', 'false');
            });
            event.target.setAttribute('aria-pressed', 'true');
            renderMenu(menuData);
        }

        // ===== DATA LOADING =====
        async function loadMenu(silent = false) {
            const menuContent = document.getElementById('menuContent');
            if (!silent) {
                menuContent.innerHTML = '<div class="loading">正在載入菜單</div>';
            }

            try {
                const res = await fetch(API_URL, { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                const raw = await res.json();

                menuData = coerceDataGrouped(raw);

                if (!menuData || typeof menuData !== 'object' || !Object.keys(menuData).length) {
                    menuContent.innerHTML = `
                        <div class="error">
                            <h3>⚠️ 沒有可顯示的菜單</h3>
                            <div class="error-details">
                                收到的資料看起來是空的或無法辨識的格式。<br/>
                                建議檢查：API_URL 是否正確、以及回傳是否含有品項資料。<br/><br/>
                                <strong>資料預覽：</strong><br/>
                                ${escapeHtml(JSON.stringify(raw).slice(0, 600))}...
                            </div>
                        </div>`;
                    return;
                }

                renderMenu(menuData);
            } catch (err) {
                console.error(err);
                menuContent.innerHTML = `
                    <div class="error">
                        <h3>❌ 載入菜單失敗</h3>
                        <p><strong>${escapeHtml(err.message)}</strong></p>
                        <div class="error-details">
                            請確認：API URL 正確、已部署，或直接開啟：
                            <div style="margin-top:6px">
                                <a href="${API_URL}" target="_blank" style="color:#ffd700;text-decoration:underline">測試 API URL</a>
                            </div>
                        </div>
                    </div>`;
            }
        }

        function coerceDataGrouped(raw) {
            if (!raw) return {};

            if (typeof raw === 'object' && !Array.isArray(raw)) {
                const out = {};
                for (const k of Object.keys(raw)) {
                    const v = raw[k];
                    if (Array.isArray(v)) out[k] = v;
                }
                if (Object.keys(out).length) return out;
            }

            if (Array.isArray(raw)) {
                const out = {};
                for (const it of raw) {
                    const cat = (it && (it.category || it.Category || it.categoryName))
                        ? String(it.category || it.Category || it.categoryName)
                        : '';
                    if (!cat) continue;
                    (out[cat] ||= []).push(stripCategory(it));
                }
                return out;
            }

            return {};
        }

        function stripCategory(it) {
            const clone = { ...it };
            delete clone.category;
            delete clone.Category;
            delete clone.categoryName;
            return clone;
        }

        // ===== RENDERING =====
        function renderMenu(data) {
            const menuContent = document.getElementById('menuContent');

            const fixedHasData = (Array.isArray(CATEGORIES) ? CATEGORIES : []).some(cat => {
                const arr = data?.[cat.name];
                return Array.isArray(arr) && arr.length > 0;
            });

            const effectiveCategories = fixedHasData
                ? CATEGORIES.map(c => c.name)
                : Object.keys(data);

            const left = document.createElement('div');
            const right = document.createElement('div');

            const toc = document.querySelector('.toc');
            toc.innerHTML = '';
            effectiveCategories.forEach((name) => {
                const items = data[name];
                if (!Array.isArray(items) || items.length === 0) return;
                const has = items.some(it => passFilters(it));
                if (!has) return;
                const a = document.createElement('a');
                a.href = `#cat-${name}`;
                a.textContent = name;
                toc.appendChild(a);
            });

            effectiveCategories.forEach((name, idx) => {
                const items = data[name];
                if (!Array.isArray(items) || items.length === 0) return;

                const filtered = items.filter(it => passFilters(it));
                if (filtered.length === 0) return;

                const section = createSection(name, filtered);

                const fixed = CATEGORIES.find(c => c.name === name);
                if (fixed) {
                    (fixed.column === 'left' ? left : right).appendChild(section);
                } else {
                    (idx % 2 === 0 ? left : right).appendChild(section);
                }
            });

            if (!left.childNodes.length && !right.childNodes.length) {
                menuContent.innerHTML = `
                    <div class="error">
                        <h3>⚠️ 找不到符合條件的菜單</h3>
                        <div class="error-details">
                            可能原因：<br/>
                            • 類別鍵名與預設不符（已嘗試動態鍵名仍無資料）<br/>
                            • 目前的搜尋或「隱藏售罄」過濾把品項都排除了
                        </div>
                    </div>`;
                return;
            }

            menuContent.innerHTML = '';
            menuContent.appendChild(left);
            menuContent.appendChild(right);
        }

        function passFilters(it) {
            if (hideSoldOut && (it.soldout === true || String(it.soldout).toLowerCase() === 'true')) {
                return false;
            }
            if (!query) return true;
            const fields = [it.zh, it.en, it.ja, it.ko, it.fr, it.th, it.fil, it.vi, it.contains, it.img]
                .filter(Boolean).join(' ').toLowerCase();
            return fields.includes(query);
        }

        function createSection(name, items) {
            const sec = document.createElement('section');
            sec.className = 'menu-section';
            sec.id = `cat-${name}`;

            const title = document.createElement('div');
            title.className = 'section-title';
            title.textContent = name;
            sec.appendChild(title);

            items.forEach(item => {
                const div = document.createElement('article');
                div.className = 'menu-item';
                if (item.soldout === true || String(item.soldout).toLowerCase() === 'true') {
                    div.classList.add('soldout');
                }

                const { text: primary, langTag: pTag } = pickLang(item, currentLang);
                const { text: secondary, langTag: sTag } = pickSecondary(item, currentLang);
                const priceStr = formatTWD(item.price);

                const imgHtml = item.img ? `
                    <img class="thumb" src="${escapeHtml(item.img)}"
                         alt="${escapeHtml(item.en || item.zh || 'item image')}"
                         loading="lazy" decoding="async" width="84" height="84"
                         onerror="this.style.display='none'" />
                ` : '';

                div.innerHTML = `
                    ${imgHtml}
                    <div class="item-name">
                        <div class="name-primary">${escapeHtml(primary)}${pTag ? ` <small style="opacity:.7">(${pTag})</small>` : ''}</div>
                        <div class="name-secondary">${escapeHtml(secondary)}${sTag ? ` <small style="opacity:.6">(${sTag})</small>` : ''}</div>
                        ${renderBadges(item)}
                    </div>
                    <div class="price" aria-label="Price">NT ${priceStr}</div>
                `;

                sec.appendChild(div);
            });

            return sec;
        }

        // ===== LANGUAGE & FORMATTING =====
        function pickLang(item, lang) {
            const val = (item[lang] || '').trim();
            if (val) return { text: val, langTag: lang };
            if ((item.en || '').trim()) return { text: item.en.trim(), langTag: 'en' };
            if ((item.zh || '').trim()) return { text: item.zh.trim(), langTag: 'zh' };
            const alt = ['ja', 'ko', 'fr', 'th', 'fil', 'vi'].map(k => item[k]).find(v => v && v.trim());
            return { text: alt ? alt.trim() : '—', langTag: alt ? 'other' : '' };
        }

        function pickSecondary(item, lang) {
            if (lang === 'en') {
                const s = (item.zh || '').trim() || '';
                return { text: s, langTag: s ? 'zh' : '' };
            } else {
                const s = (item.en || '').trim() || (item.zh || '').trim() || '';
                return { text: s, langTag: s ? (item.en ? 'en' : 'zh') : '' };
            }
        }

        const twdFmt = new Intl.NumberFormat('zh-TW', {
            style: 'currency',
            currency: 'TWD',
            maximumFractionDigits: 0
        });

        function formatTWD(v) {
            const n = Number(v);
            return isFinite(n) ? twdFmt.format(n) : (v ?? '');
        }

        function renderBadges(item) {
            const badges = [];

            if (String(item.vegan).toLowerCase() === 'true') {
                badges.push(`<span class="badge vegan" title="Vegan / 純素">Vegan</span>`);
            }

            const spicy = Number(item.spicy);
            if (isFinite(spicy) && spicy > 0) {
                badges.push(`<span class="badge spicy" title="Spicy / 辣度">${'🌶'.repeat(Math.min(spicy, 3))}</span>`);
            }

            if (item.contains) {
                const list = String(item.contains)
                    .split(/[,\uFF0C;；]/)
                    .map(s => s.trim())
                    .filter(Boolean);
                if (list.length) {
                    badges.push(`<span class="badge allergen" title="Allergens / 過敏原">${escapeHtml(list.join(' · '))}</span>`);
                }
            }

            return badges.length ? `<div class="badges">${badges.join('')}</div>` : '';
        }

        function escapeHtml(s) {
            return String(s ?? '').replace(/[&<>"']/g, c => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[c]));
        }

        // ===== START =====
        init();
    </script>
</body>

</html>
